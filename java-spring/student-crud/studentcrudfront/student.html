<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student-Crud </title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        #header-text {
            color: green;
        }
        .error{
            color: red;
            font-weight: bold;
        }
    </style>

</head>

<body>
    <div style="width: 30%;margin:auto;">
        <h3 id="header-text"></h3>
        <form onsubmit="onSaveStudent(event)">
            <div class="form-group">
                <label for="student-name">Ad</label>
                <input id="student-name" class="form-control">
                <div id="name-error" class="error"></div>
            </div>
            <div class="form-group">
                <label for="student-surname">Soyad</label>
                <input id="student-surname" class="form-control">
                <div id="surname-error" class="error"></div>
            </div>
            <input type="submit" value="Yadda saxla" class="btn btn-success">
        </form>
    </div>
    <hr>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>Kod</th>
                <th>Ad</th>
                <th>Soyad</th>
            </tr>
        </thead>
        <tbody id="students-tbody">

        </tbody>
    </table>
    </div>

    <div class="modal fade" id="noteModal"> // fade yavas yavas gelmesidir
        <div class="modal-dialog">
          <div class="modal-content">
    
            <div class="modal-header">
              <h4 class="modal-title">New Note</h4>
              <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form onsubmit="onSaveStudentNote(event)">
                    <div class="form-group">
                        <label for="student-note">Note</label>
                        <input id="student-note" class="form-control">
                    </div>
                    <input type="submit" value="Yadda saxla" class="btn btn-success">
                </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>
    <script>
        var selectedStudentId = 0;
        var API_URL = "http://localhost:8585"; //secilmis telebenin id sini bu deyisene memimsedirik
        var studentNameInput = document.getElementById('student-name'); //bunu basda hecbir funksiyanin icinde olmamaqla elaqelendirdik harda lazimdirsa bu sekilde istifade edirik
        var studentSurnameInput = document.getElementById('student-surname');

        var studentsTbodyElement = document.getElementById('students-tbody');

        var headerTextElement = document.getElementById('header-text');

        var nameErrorElement=document.getElementById('name-error');
        var surnameErrorElement=document.getElementById('surname-error');

        var studentNoteInput = document.getElementById('student-note');
        function onSaveStudent(event) {

            event.preventDefault(); //form un default gelen ozelliyini legv edirik form yenilemeli deyil mane olur 
            var studentName = studentNameInput.value // adini yazacagimiz inputu qaytarir
            var studentSurname = studentSurnameInput.value;

            var studentObject = {};
            studentObject.id = selectedStudentId; //secdiyimiz id update edir yeni telebe etmir daha 
            studentObject.name = studentName; // (name ) back end le ad eyni olmalidir
            studentObject.surname = studentSurname;

            var http = new XMLHttpRequest(); //ajax request sinifinnen obyekt yaradiriq

            http.onload = function () {
                //bazada olan butun telebeleri cedvele yuklemek
                //servere e melumat gonderirik serverden cavab gelende yoxlayiriq ki eger kod 400 durse 
                if(this.status==400){
                    var nameError="";
                    var surnameError="";
                  var erroObject=JSON.parse(this.responseText); //js formatina ceviririkk
                  erroObject.validations.forEach(error => {
                        if(error.field=='name'){ //eger field name dirse demeli name ein errorudur
                         
                           nameError+=error.message+"<br>";
                        }
                        if(error.field=='surname'){ 
                            surnameError+=error.message+"<br>";
                        }
                    });
                           nameErrorElement.innerHTML=nameError; //id si name-error dursa
                           surnameErrorElement.innerHTML=surnameError; 
                } else{
                    clearErrorMessages();
                selectedStudentId = 0; // redakte etdikden sonra yeniden 0 edirikki telebe qeydiyatina kecsin
                setHeaderText('Yeni Telebe Qeydiyyati ');
                loadAllStudents();
                }
            }

            http.open("POST", API_URL + "/students", true)//metodun tipi , cagiracagimiz yer 
            http.setRequestHeader("Content-Type", "application/json")
            http.send(JSON.stringify(studentObject)); // json un stringfy funksiyasi json a cevirir 
            
        }
        function loadAllStudents() {
            var http = new XMLHttpRequest();
            http.onload = function () {
                var response = this.responseText;
                var studentsArray = JSON.parse(response);
                fillStudentsTable(studentsArray); // bu funksiya massivi istifade ede bilsin icerisinde  patametr gonderirik
            }

            http.open("GET", API_URL + "/students", true)

            http.send();
        }
        function fillStudentsTable(students) {
            var studentsTbodyHtml = "";
            for (var i = 0; i < students.length; i++) {
                var student = students[i];
                studentsTbodyHtml += "<tr><td>" + student.id + "</td>";
                studentsTbodyHtml += "<td>" + student.name + "</td>";
                studentsTbodyHtml += "<td>" + student.surname + "</td>";
                studentsTbodyHtml += "<td><button class='btn btn-danger' onclick='onDeleteStudent("
                    + student.id + ")'>Delete</button>  ";
                studentsTbodyHtml += "<button class='btn btn-primary' onclick='onEditStudent("
                    + student.id + ")' >Update</button>  ";

                    studentsTbodyHtml += "<button class='btn btn-secondary' onclick='onNoteStudent("
                    + student.id + ")' type='button'  data-toggle='modal' data-target='#noteModal'>Note</button></td></tr>";
            }
            studentsTbodyElement.innerHTML = studentsTbodyHtml; //tbody ni icerisini tr lerle doldurur
        }
        loadAllStudents();
        function onDeleteStudent(studentId) {
            if (confirm('Silmeye eminsen?')) {


                var http = new XMLHttpRequest();
                http.onload = function () {
                    loadAllStudents(); // birce defe sehifeni yenilemek ucundur 
                }

                http.open("DELETE", API_URL + "/students/" + studentId, true)

                http.send();
            }
        }
        function onEditStudent(studentId) {
            selectedStudentId = studentId;
            setHeaderText('Telebe Redaqtesi id si -> ' + studentId);
            var http = new XMLHttpRequest();
            http.onload = function () {
                var response = this.responseText; //butun srvisleri cagiranda json gelirse hemise bucur olur ve parse etmeliyik js ya
                var studentObject = JSON.parse(response)
                studentNameInput.value = studentObject.name; // serverden gelen name i yerlesdiririk id si studetn name olan inputun daxiline 
                studentSurnameInput.value = studentObject.surname;
            }

            http.open("GET", API_URL + "/students/" + studentId, true) // id sine gore melumati qaytaracaq

            http.send();
        }
        function setHeaderText(text) {
            headerTextElement.innerHTML = text;
        }
        setHeaderText('Yeni Telebe Qeydiyyati ');
        function clearErrorMessages(){
            nameErrorElement.innerHTML=""; //error yoxdursa error mesajlarini temizleyirik
            surnameErrorElement.innerHTML="";
        }

        function onNoteStudent(studentId) {
            selectedStudentId = studentId;
            
        }


        function onSaveStudentNote(event) {

event.preventDefault(); //form un default gelen ozelliyini legv edirik form yenilemeli deyil mane olur 
var studentNote = studentNoteInput.value // bu inputdan goturub server e gonderir


var studentNoteObject = {};

studentNoteObject.note = studentNote; // server e gondermekcun hazirliyiriq
studentNoteObject.studentId=selectedStudentId;

var http = new XMLHttpRequest(); //ajax request sinifinnen obyekt yaradiriq

http.onload = function () {
    //bazada olan butun telebeleri cedvele yuklemek
    //servere e melumat gonderirik serverden cavab gelende yoxlayiriq ki eger kod 400 durse 
    if(this.status==400){
      alert('Qeyd elave edile bilmedi!');
    } else{
   alert('Qeyd elave edildi');
    }
}

http.open("POST", API_URL + "/student-notes", true)//metodun tipi , cagiracagimiz yer 
http.setRequestHeader("Content-Type", "application/json")
http.send(JSON.stringify(studentNoteObject)); // json un stringfy funksiyasi json a cevirir 
2
}
    </script>


</body>

</html>